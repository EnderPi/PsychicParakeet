@page "/logs"
@attribute [Authorize]
@inject EnderPi.Framework.DataAccess.LogDataAccess logDataAccess

<h3>Logs</h3>

<p>Records: @currentCount</p>

<EditForm Model="SearchModel">
    <table>
        <tr>
            <td>Source:</td>
            <td><InputText @bind-Value="SearchModel.Source" /></td>
        </tr>

        <tr>
            <td>Begin Date:</td>
            <td><input type="datetime" @bind="SearchModel.BeginTime" /></td>
        </tr>

        <tr>
            <td>End Date:</td>
            <td><input type="datetime" @bind="SearchModel.EndTime" /></td>
        </tr>
        <tr>
            <td>Message contains:</td>
            <td><InputText @bind-Value="SearchModel.Message" /></td>
        </tr>
        <tr>
            <td>
                <InputCheckbox @bind-Value="@SearchModel.ShowDebug" id="showDebug"></InputCheckbox><label style="padding-left:6px" for="showDebug">Debug</label>
            </td>
            <td>
                <InputCheckbox @bind-Value="@SearchModel.ShowInformation" id="showInformation"></InputCheckbox><label style="padding-left:6px" for="showInformation">Information</label>
            </td>
        </tr>
        <tr>
            <td>
                <InputCheckbox @bind-Value="@SearchModel.ShowWarning" id="showWarning"></InputCheckbox><label style="padding-left:6px" for="showWarning">Warning</label>
            </td>
            <td>
                <InputCheckbox @bind-Value="@SearchModel.ShowError" id="showError"></InputCheckbox><label style="padding-left:6px" for="showError">Error</label>
            </td>
        </tr>
        <tr>
            <td>
                <InputCheckbox @bind-Value="@SearchModel.ShowFatal" id="showFatal"></InputCheckbox><label style="padding-left:6px" for="showFatal">Fatal</label>
            </td>
            <td>
            </td>
        </tr>
    </table>
</EditForm>
<p>
    <button type="button" class="btn btn-primary" @onclick="SearchLogs">Search</button>
</p>

@if (Show)
{
    <div class="pop-container">
    <div class="popconfirm">
        <h4>Log Details</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Key</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody>
                @if (Details != null)
                    {
                @foreach (var detail in Details.Values)
                        {
                <tr>
                    <td>@detail.Item1</td>
                    <td width="500">@detail.Item2</td>
                </tr>
                        }
                    }
            </tbody>
        </table>

        <button type="button" class="btn btn-primary" @onclick="() => ClosePopup()">Close</button>
    </div>
</div>
}

<table class="table">
    <thead>
        <tr>
            <th>Id</th>
            <th>Source</th>
            <th>TimeStamp</th>
            <th>Log Level</th>
            <th>Message</th>
            <th>Details</th>
        </tr>
    </thead>
    <tbody>

        @foreach (var logMessage in logMessages)
        {
            <tr>
                <td>@logMessage.Id</td>
                <td>@logMessage.Source</td>
                <td>@logMessage.TimeStamp.ToString("g")</td>
                <td>@logMessage.LogLevel</td>
                <td>@logMessage.Message</td>
                <td><button class="btn btn-primary" @onclick="@(()=>HandleRowClick(logMessage.Id))">Details</button></td>
            </tr>
        }
    </tbody>
</table>

@code {

    private EnderPi.Framework.Logging.LogSearchModel SearchModel = new EnderPi.Framework.Logging.LogSearchModel() { BeginTime = DateTime.MinValue, EndTime = DateTime.MinValue, ShowError=true, ShowFatal=true };

    private int currentCount = 0;

    private EnderPi.Framework.Logging.LogMessage[] logMessages;

    private bool Show { set; get; }

    public EnderPi.Framework.Logging.LogDetails Details { set; get; }

    protected override Task OnInitializedAsync()
    {
        RefreshCount();
        return base.OnInitializedAsync();
    }

    private void RefreshCount()
    {
        currentCount = logDataAccess.GetCurrentCount();
        logMessages = logDataAccess.GetTopLogMessages(10);
    }

    private void HandleRowClick(long logId)
    {
        currentCount++;
        Details = logDataAccess.GetLogDetails(logId);
        Show = true;
    }

    public void ClosePopup()
    {
        Show = false;
    }

    public void SearchLogs()
    {
        //TODO validation
        logMessages = logDataAccess.SearchLogMessages(SearchModel);
    }

}

