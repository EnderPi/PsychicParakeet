@page "/logs"
@attribute [Authorize]

<h3>Logs</h3>

<p>Records: @currentCount</p>

<button class="btn btn-primary" @onclick="RefreshCount">Click me</button>

<table class="table">
    <thead>
        <tr>
            <th>Id</th>
            <th>Source</th>
            <th>TimeStamp</th>
            <th>Log Level</th>
            <th>Message</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var logMessage in logMessages)
        {            
        <tr @onclick="@(e=>HandleRowClick(logMessage.Id))">
            <td>@logMessage.Id</td>
            <td>@logMessage.Source</td>
            <td>@logMessage.TimeStamp.ToLongTimeString()</td>
            <td>@logMessage.LogLevel</td>
            <td>@logMessage.Message</td>
        </tr>
        }
    </tbody>
</table>

@code {
    private EnderPi.Framework.DataAccess.LogDataAccess logDataAccess = new EnderPi.Framework.DataAccess.LogDataAccess("Server=localhost;Integrated Security = SSPI; Database=PangolinDev;Trusted_Connection=True;");

    private int currentCount = 0;

    private EnderPi.Framework.Logging.LogMessage[] logMessages;

    protected override Task OnInitializedAsync()
    {
        currentCount = logDataAccess.GetCurrentCount();
        logMessages = logDataAccess.GetTopLogMessages(10);

        return base.OnInitializedAsync();
    }

    private void RefreshCount()
    {
        currentCount = logDataAccess.GetCurrentCount();
        logMessages = logDataAccess.GetTopLogMessages(10);
    }

    private void HandleRowClick(long logId)
    {
        //show that pop-up with the key-value pairs.
    }

}

